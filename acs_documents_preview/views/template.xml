<?xml version="1.0" encoding="UTF-8"?>
<odoo>
 <template id="acs_image_preview" name="Image Preview">
     <style>
         #imageCanvas {
             border: 1px solid black; /* Make the canvas visible */
         }
         #thumbnailMenu {
             width: 100px; /* Adjust as needed */
             overflow-y: auto;
             height: 500px; /* Adjust as needed */
             border: 1px solid black;
         }
         #thumbnailMenu img {
             width: 100%; /* Thumbnails take full width of the menu */
             cursor: pointer;
         }
     </style>
     <div id="wrap">
         <div class="row">
             <div class="col-md-2">
                 <div id="thumbnailMenu">
                     <t t-as="im" t-foreach="attachments">
                         <img t-attf-src="/web/content/#{im.id}"
                              t-att-alt="im.name"
                              t-attf-data-image="/web/content/#{im.id}"
                              t-att-title="im.name"
                              class="thumbnail-image"/>
                     </t>
                 </div>
             </div>
             <div class="col-md-10">
                 <section>
                     <div class="container s_image_editor" id="tui-image-editor">
                         <div class="row mt64">
                             <div class="col-12">
                                 <div id="gallery" class="mt64" style="display:none;">
                                     <!-- Original gallery, now hidden -->
                                 </div>
                                 <button class="o_edit_file_button btn btn-light border-0 m-1 p-1" style="width: 50px; height:20px; display:none;">
                                     <span>Edit</span>
                                 </button>
                             </div>
                         </div>
                     </div>
<div class="text-center">
    <form action="/my/acs/image/hms.patient/2/update_image" method="post" enctype='multipart/form-data'>
        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
        <!-- Replace '2' with the actual record ID dynamically -->
        <input type="hidden" name="record_id" t-esc="record_id"/> <!-- Ensure record_id is provided in the context -->
        <input name="image_data" id="image_data" type="hidden"/>
        <button type="button" class="btn btn-primary mt16" id="save_image">Save Image</button>
    </form>
</div>
                 </section>
                 <div>
                     <canvas id="imageCanvas" width="500" height="500"></canvas>
                 </div>
             </div>
         </div>
     </div>
     <script src="/web/static/lib/jquery/jquery.js" type="text/javascript"></script>
     <script type="text/javascript" src="https://unpkg.com/canvas-select@%5E2/lib/canvas-select.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        var img = document.getElementById('imageCanvas');
        var ctx = img.getContext('2d');

        $('.thumbnail-image').click(function() {
            var imgElement = document.createElement('img');
            imgElement.src = $(this).attr('data-image');
            console.log("Loading image", imgElement.src);
            imgElement.onload = function() {
                console.log("Image loaded");
                ctx.clearRect(0, 0, img.width, img.height);
                ctx.drawImage(imgElement, 0, 0);
            };
        });

        var isDrawing = false;
        $('#imageCanvas').mousedown(function(e) {
            isDrawing = true;
            var rect = img.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }).mouseup(function() {
            isDrawing = false;
        }).mousemove(function(e) {
            if (!isDrawing) return;
            var rect = img.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        });

        // Attach the click event to the 'Save Image' button
        $('#save_image').click(function() {
            var canvas = document.getElementById('imageCanvas');
            var imageData = canvas.toDataURL('image/png');
            $('#image_data').val(imageData);

            // Submit the form programmatically
            $(this).closest('form').submit();
        });
    });
</script>

 </template>
</odoo>